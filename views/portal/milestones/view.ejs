<%- include('../../partials/portal-header', { currentPage: 'milestones', pageTitle: milestoneTitle }) %>

<div class="page-actions">
  <a href="/portal/milestones" class="btn btn-outline">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
    Back to Milestones
  </a>
</div>

<!-- Milestone Header Card -->
<div class="milestone-hero">
  <div class="milestone-hero-badge">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
  </div>
  <div class="milestone-hero-content">
    <h1 class="milestone-hero-title"><%= milestoneTitle %></h1>
    <div class="milestone-hero-stats">
      <div class="milestone-hero-stat">
        <span class="milestone-hero-stat-value"><%= achievers.length %></span>
        <span class="milestone-hero-stat-label">Participant<%= achievers.length !== 1 ? 's' : '' %></span>
      </div>
      <div class="milestone-hero-stat">
        <span class="milestone-hero-stat-value">
          <% 
            const dates = achievers.filter(a => a.MilestoneDate).map(a => new Date(a.MilestoneDate));
            const latestDate = dates.length > 0 ? new Date(Math.max(...dates)) : null;
          %>
          <%= latestDate ? latestDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : 'N/A' %>
        </span>
        <span class="milestone-hero-stat-label">Latest Achievement</span>
      </div>
    </div>
  </div>
</div>

<!-- Achievers Section -->
<div class="achievers-section">
  <div class="achievers-header">
    <h2>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      Participants Who Achieved This Milestone
    </h2>
  </div>
  
  <% if (achievers && achievers.length > 0) { %>
  <div class="achievers-grid">
    <% achievers.forEach((a, index) => { 
      const initials = (a.ParticipantFirstName || '?').charAt(0) + (a.ParticipantLastName || '?').charAt(0);
      const avatarColors = ['#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#00bcd4', '#009688', '#4caf50', '#ff9800'];
      const colorIndex = (a.ParticipantFirstName || '').charCodeAt(0) % avatarColors.length;
    %>
    <div class="achiever-card" style="animation-delay: <%= index * 0.05 %>s">
      <div class="achiever-avatar" style="background: <%= avatarColors[colorIndex] %>">
        <%= initials %>
      </div>
      <div class="achiever-info">
        <a href="/portal/participants/<%= a.ParticipantID %>" class="achiever-name">
          <%= a.ParticipantFirstName %> <%= a.ParticipantLastName %>
        </a>
        <div class="achiever-date">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          <%= a.MilestoneDate ? new Date(a.MilestoneDate).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }) : 'Date not set' %>
        </div>
        <% if (a.MilestoneNo) { %>
        <div class="achiever-milestone-number">
          Milestone #<%= a.MilestoneNo %>
        </div>
        <% } %>
      </div>
      <div class="achiever-actions">
        <a href="/portal/milestones/<%= a.MilestoneID %>" class="btn-icon" title="View Record" aria-label="View milestone record">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </a>
        <% if (user && user.role === 'Admin') { %>
        <a href="/portal/milestones/<%= a.MilestoneID %>/edit" class="btn-icon" title="Edit" aria-label="Edit milestone">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </a>
        <form action="/portal/milestones/<%= a.MilestoneID %>/delete" method="POST" class="inline-form" onsubmit="return confirm('Remove this achievement record?')">
          <button type="submit" class="btn-icon btn-icon--danger" title="Delete" aria-label="Remove achievement">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          </button>
        </form>
        <% } %>
      </div>
    </div>
    <% }) %>
  </div>
  <% } else { %>
  <div class="empty-achievers">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
    <p>No participants have achieved this milestone yet</p>
  </div>
  <% } %>
</div>

<style>
/* Milestone Hero Section */
.milestone-hero {
  display: flex;
  align-items: center;
  gap: var(--space-xl);
  background: linear-gradient(135deg, var(--color-primary) 0%, #1a237e 100%);
  padding: var(--space-2xl);
  border-radius: var(--radius-xl);
  margin-bottom: var(--space-xl);
  position: relative;
  overflow: hidden;
}

.milestone-hero::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -20%;
  width: 400px;
  height: 400px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.milestone-hero::after {
  content: '';
  position: absolute;
  bottom: -30%;
  left: 10%;
  width: 200px;
  height: 200px;
  background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
  border-radius: 50%;
}

.milestone-hero-badge {
  width: 100px;
  height: 100px;
  background: linear-gradient(135deg, var(--color-accent-rose) 0%, #f48fb1 100%);
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  position: relative;
  z-index: 1;
}

.milestone-hero-badge svg {
  color: var(--color-white);
}

.milestone-hero-content {
  flex: 1;
  position: relative;
  z-index: 1;
}

.milestone-hero-title {
  font-size: var(--text-2xl);
  font-weight: 800;
  color: var(--color-white);
  margin: 0 0 var(--space-lg) 0;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.milestone-hero-stats {
  display: flex;
  gap: var(--space-2xl);
}

.milestone-hero-stat {
  display: flex;
  flex-direction: column;
}

.milestone-hero-stat-value {
  font-size: var(--text-xl);
  font-weight: 700;
  color: var(--color-white);
}

.milestone-hero-stat-label {
  font-size: var(--text-sm);
  color: rgba(255, 255, 255, 0.75);
}

/* Achievers Section */
.achievers-section {
  background: var(--color-white);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.achievers-header {
  padding: var(--space-lg) var(--space-xl);
  border-bottom: 1px solid var(--color-gray-200);
  background: var(--color-gray-50);
}

.achievers-header h2 {
  display: flex;
  align-items: center;
  gap: var(--space-md);
  font-size: var(--text-lg);
  font-weight: 600;
  margin: 0;
  color: var(--color-gray-800);
}

.achievers-header h2 svg {
  color: var(--color-accent-sage);
}

/* Achievers Grid */
.achievers-grid {
  display: grid;
  gap: 0;
}

.achiever-card {
  display: flex;
  align-items: center;
  gap: var(--space-lg);
  padding: var(--space-lg) var(--space-xl);
  border-bottom: 1px solid var(--color-gray-100);
  transition: all 0.2s ease;
  animation: fadeIn 0.4s ease forwards;
  opacity: 0;
}

@keyframes fadeIn {
  to {
    opacity: 1;
  }
}

.achiever-card:last-child {
  border-bottom: none;
}

.achiever-card:hover {
  background: var(--color-gray-50);
}

.achiever-avatar {
  width: 52px;
  height: 52px;
  border-radius: var(--radius-full);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--color-white);
  font-weight: 700;
  font-size: var(--text-base);
  flex-shrink: 0;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
}

.achiever-info {
  flex: 1;
  min-width: 0;
}

.achiever-name {
  display: block;
  font-weight: 600;
  font-size: var(--text-base);
  color: var(--color-gray-900);
  text-decoration: none;
  margin-bottom: var(--space-xs);
  transition: color 0.2s ease;
}

.achiever-name:hover {
  color: var(--color-primary);
}

.achiever-date {
  display: flex;
  align-items: center;
  gap: var(--space-xs);
  font-size: var(--text-sm);
  color: var(--color-gray-500);
}

.achiever-date svg {
  opacity: 0.6;
}

.achiever-milestone-number {
  display: inline-block;
  margin-top: var(--space-xs);
  padding: var(--space-xs) var(--space-sm);
  background: var(--color-accent-lavender);
  color: white;
  font-size: var(--text-xs);
  font-weight: 600;
  border-radius: var(--radius-sm);
}

.achiever-actions {
  display: flex;
  gap: var(--space-xs);
  flex-shrink: 0;
}

/* Empty Achievers State */
.empty-achievers {
  text-align: center;
  padding: var(--space-3xl);
  color: var(--color-gray-500);
}

.empty-achievers svg {
  margin-bottom: var(--space-md);
  opacity: 0.5;
}

.empty-achievers p {
  margin: 0;
  font-size: var(--text-base);
}

/* Responsive */
@media (max-width: 768px) {
  .milestone-hero {
    flex-direction: column;
    text-align: center;
    padding: var(--space-xl);
  }
  
  .milestone-hero-badge {
    width: 80px;
    height: 80px;
  }
  
  .milestone-hero-badge svg {
    width: 36px;
    height: 36px;
  }
  
  .milestone-hero-title {
    font-size: var(--text-xl);
  }
  
  .milestone-hero-stats {
    justify-content: center;
    gap: var(--space-xl);
  }
  
  .achiever-card {
    flex-wrap: wrap;
    padding: var(--space-lg);
  }
  
  .achiever-info {
    flex: 1;
    min-width: calc(100% - 80px);
  }
  
  .achiever-actions {
    width: 100%;
    justify-content: center;
    padding-top: var(--space-md);
    margin-top: var(--space-md);
    border-top: 1px solid var(--color-gray-100);
  }
}
</style>

<%- include('../../partials/portal-footer') %>
