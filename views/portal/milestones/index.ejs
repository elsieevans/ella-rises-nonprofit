<%- include('../../partials/portal-header', { currentPage: 'milestones', pageTitle: 'Milestones' }) %>

<!-- Stats Overview with Add Button -->
<% if (stats) { %>
<div class="page-header-with-stats">
  <div class="milestone-stats-overview">
    <div class="milestone-stat-item">
      <div class="milestone-stat-icon milestone-stat-icon--types">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      </div>
      <div class="milestone-stat-content">
        <span class="milestone-stat-value"><%= stats.uniquecount || 0 %></span>
        <span class="milestone-stat-label">Milestone Types</span>
      </div>
    </div>
    <div class="milestone-stat-item">
      <div class="milestone-stat-icon milestone-stat-icon--achievements">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
      </div>
      <div class="milestone-stat-content">
        <span class="milestone-stat-value"><%= stats.totalachievements || 0 %></span>
        <span class="milestone-stat-label">Total Achievements</span>
      </div>
    </div>
  </div>
  <div class="page-actions">
    <% if (user && user.role === 'Admin') { %>
      <a href="/portal/milestones/new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Milestone
      </a>
    <% } %>
  </div>
</div>
<% } else { %>
<div class="page-actions" style="justify-content: flex-end;">
  <% if (user && user.role === 'Admin') { %>
    <a href="/portal/milestones/new" class="btn btn-primary">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Milestone
    </a>
  <% } %>
</div>
<% } %>

<!-- Search Filter -->
<div class="filters-card">
  <form class="filters-form" method="GET" action="/portal/milestones">
    <div class="filter-group">
      <label for="search">Search Milestones</label>
      <input type="text" id="search" name="search" value="<%= filters.search || '' %>" placeholder="Search by milestone name...">
    </div>
    <button type="submit" class="btn btn-secondary">Search</button>
    <a href="/portal/milestones" class="btn btn-outline">Clear</a>
  </form>
</div>

<!-- Milestones Grid -->
<% if (milestones && milestones.length > 0) { %>
  <% 
    const myMilestones = milestones.filter(m => userMilestoneSet.has(m.MilestoneTitle));
    const otherMilestones = milestones.filter(m => !userMilestoneSet.has(m.MilestoneTitle));
  %>
  
  <% if (myMilestones.length > 0) { %>
  <div class="milestones-section">
    <h2 class="milestones-section-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
      My Milestones
    </h2>
    <div class="milestone-gallery">
      <% myMilestones.forEach((m, index) => { 
        // Generate a color based on the milestone name
        const colors = ['rose', 'sage', 'lavender', 'peach', 'sky', 'magenta'];
        const colorIndex = m.MilestoneTitle.charCodeAt(0) % colors.length;
        const colorClass = colors[colorIndex];
      %>
      <a href="/portal/milestones/view/<%= encodeURIComponent(m.MilestoneTitle) %>" class="milestone-gallery-card milestone-gallery-card--<%= colorClass %> milestone-gallery-card--mine" style="animation-delay: <%= index * 0.05 %>s">
        <div class="milestone-gallery-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
        </div>
        <div class="milestone-gallery-content">
          <div class="milestone-badge-mine">You achieved this!</div>
          <h3 class="milestone-gallery-title"><%= m.MilestoneTitle %></h3>
          <div class="milestone-gallery-meta">
            <span class="milestone-achiever-count">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              <%= m.achieverCount %> participant<%= m.achieverCount != 1 ? 's' : '' %>
            </span>
            <% if (m.latestDate) { %>
            <span class="milestone-latest-date">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              Latest: <%= new Date(m.latestDate).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) %>
            </span>
            <% } %>
          </div>
        </div>
        <div class="milestone-gallery-arrow">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
      </a>
      <% }) %>
    </div>
  </div>
  <% } %>
  
  <% if (otherMilestones.length > 0) { %>
  <div class="milestones-section">
    <h2 class="milestones-section-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
      <%= myMilestones.length > 0 ? 'Other Milestones' : 'All Milestones' %>
    </h2>
    <div class="milestone-gallery">
      <% otherMilestones.forEach((m, index) => { 
        // Generate a color based on the milestone name
        const colors = ['rose', 'sage', 'lavender', 'peach', 'sky', 'magenta'];
        const colorIndex = m.MilestoneTitle.charCodeAt(0) % colors.length;
        const colorClass = colors[colorIndex];
      %>
      <a href="/portal/milestones/view/<%= encodeURIComponent(m.MilestoneTitle) %>" class="milestone-gallery-card milestone-gallery-card--<%= colorClass %>" style="animation-delay: <%= index * 0.05 %>s">
        <div class="milestone-gallery-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
        </div>
        <div class="milestone-gallery-content">
          <h3 class="milestone-gallery-title"><%= m.MilestoneTitle %></h3>
          <div class="milestone-gallery-meta">
            <span class="milestone-achiever-count">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              <%= m.achieverCount %> participant<%= m.achieverCount != 1 ? 's' : '' %>
            </span>
            <% if (m.latestDate) { %>
            <span class="milestone-latest-date">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              Latest: <%= new Date(m.latestDate).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) %>
            </span>
            <% } %>
          </div>
        </div>
        <div class="milestone-gallery-arrow">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
      </a>
      <% }) %>
    </div>
  </div>
  <% } %>
<% } else { %>
<div class="empty-state">
  <div class="empty-state-icon">
    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
  </div>
  <h3>No Milestones Found</h3>
  <p>
    <% if (filters.search) { %>
      No milestones match your search "<%= filters.search %>". Try a different search term.
    <% } else { %>
      There are no milestones recorded yet. Add your first milestone to get started!
    <% } %>
  </p>
  <% if (user && user.role === 'Admin') { %>
  <a href="/portal/milestones/new" class="btn btn-primary">Add First Milestone</a>
  <% } %>
</div>
<% } %>

<style>
/* Milestones Sections */
.milestones-section {
  margin-bottom: var(--space-2xl);
}

.milestones-section:last-child {
  margin-bottom: 0;
}

.milestones-section-title {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
  font-size: var(--text-xl);
  font-weight: 700;
  color: var(--color-gray-800);
  margin-bottom: var(--space-lg);
  padding-bottom: var(--space-sm);
  border-bottom: 2px solid var(--color-gray-200);
}

.milestones-section-title svg {
  color: var(--color-primary);
}

/* My Milestone Badge */
.milestone-badge-mine {
  display: inline-block;
  padding: var(--space-xs) var(--space-sm);
  background: linear-gradient(135deg, #F8BBD0 0%, #f48fb1 100%);
  color: white;
  font-size: var(--text-xs);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-radius: var(--radius-sm);
  margin-bottom: var(--space-xs);
  box-shadow: 0 2px 4px rgba(244, 143, 177, 0.3);
}

.milestone-gallery-card--mine {
  border: 2px solid transparent;
  background: linear-gradient(white, white) padding-box,
              linear-gradient(135deg, #F8BBD0 0%, #f48fb1 100%) border-box;
  box-shadow: 0 4px 12px rgba(244, 143, 177, 0.2);
}

.milestone-gallery-card--mine:hover {
  box-shadow: 0 8px 24px rgba(244, 143, 177, 0.3);
}

/* Milestone Stats Overview */
.milestone-stats-overview {
  display: flex;
  gap: var(--space-lg);
  margin-bottom: var(--space-xl);
}

.page-header-with-stats .milestone-stats-overview {
  margin-bottom: 0;
}

.milestone-stat-item {
  display: flex;
  align-items: center;
  gap: var(--space-md);
  background: var(--color-white);
  padding: var(--space-lg) var(--space-xl);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  flex: 1;
}

.milestone-stat-icon {
  width: 56px;
  height: 56px;
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
}

.milestone-stat-icon svg {
  color: var(--color-white);
}

.milestone-stat-icon--types {
  background: linear-gradient(135deg, #F8BBD0 0%, #f48fb1 100%);
}

.milestone-stat-icon--achievements {
  background: linear-gradient(135deg, #F8BBD0 0%, #f48fb1 100%);
}

.milestone-stat-content {
  display: flex;
  flex-direction: column;
}

.milestone-stat-value {
  font-size: var(--text-2xl);
  font-weight: 800;
  color: var(--color-gray-900);
  line-height: 1;
}

.milestone-stat-label {
  font-size: var(--text-sm);
  color: var(--color-gray-500);
  margin-top: var(--space-xs);
}

/* Milestone Gallery Grid */
.milestone-gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: var(--space-lg);
}

.milestone-gallery-card {
  display: flex;
  align-items: center;
  gap: var(--space-lg);
  background: var(--color-white);
  padding: var(--space-xl);
  border-radius: var(--radius-xl);
  text-decoration: none;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  animation: fadeSlideIn 0.5s ease forwards;
  opacity: 0;
  transform: translateY(10px);
}

@keyframes fadeSlideIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.milestone-gallery-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  transition: width 0.3s ease;
}

.milestone-gallery-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.milestone-gallery-card:hover::before {
  width: 6px;
}

.milestone-gallery-card:hover .milestone-gallery-arrow {
  transform: translateX(4px);
  opacity: 1;
}

/* Color variations */
.milestone-gallery-card--rose::before { background: linear-gradient(180deg, #F8BBD0, #f48fb1); }
.milestone-gallery-card--rose .milestone-gallery-icon { background: linear-gradient(135deg, #F8BBD0, #f48fb1); }

.milestone-gallery-card--sage::before { background: linear-gradient(180deg, #F8BBD0, #f48fb1); }
.milestone-gallery-card--sage .milestone-gallery-icon { background: linear-gradient(135deg, #F8BBD0, #f48fb1); }

.milestone-gallery-card--lavender::before { background: linear-gradient(180deg, #F8BBD0, #f48fb1); }
.milestone-gallery-card--lavender .milestone-gallery-icon { background: linear-gradient(135deg, #F8BBD0, #f48fb1); }

.milestone-gallery-card--peach::before { background: linear-gradient(180deg, #F8BBD0, #f48fb1); }
.milestone-gallery-card--peach .milestone-gallery-icon { background: linear-gradient(135deg, #F8BBD0, #f48fb1); }

.milestone-gallery-card--sky::before { background: linear-gradient(180deg, #F8BBD0, #f48fb1); }
.milestone-gallery-card--sky .milestone-gallery-icon { background: linear-gradient(135deg, #F8BBD0, #f48fb1); }

.milestone-gallery-card--magenta::before { background: linear-gradient(180deg, #F8BBD0, #f48fb1); }
.milestone-gallery-card--magenta .milestone-gallery-icon { background: linear-gradient(135deg, #F8BBD0, #f48fb1); }

.milestone-gallery-icon {
  width: 64px;
  height: 64px;
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.milestone-gallery-icon svg {
  color: var(--color-white);
}

.milestone-gallery-content {
  flex: 1;
  min-width: 0;
}

.milestone-gallery-title {
  font-size: var(--text-lg);
  font-weight: 700;
  color: var(--color-gray-900);
  margin: 0 0 var(--space-sm) 0;
  line-height: 1.3;
}

.milestone-gallery-meta {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-md);
}

.milestone-achiever-count,
.milestone-latest-date {
  display: flex;
  align-items: center;
  gap: var(--space-xs);
  font-size: var(--text-sm);
  color: var(--color-gray-500);
}

.milestone-achiever-count svg,
.milestone-latest-date svg {
  opacity: 0.7;
}

.milestone-gallery-arrow {
  color: var(--color-gray-400);
  transition: all 0.3s ease;
  opacity: 0.5;
  flex-shrink: 0;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: var(--space-4xl) var(--space-xl);
  background: var(--color-white);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-sm);
}

.empty-state-icon {
  width: 120px;
  height: 120px;
  margin: 0 auto var(--space-xl);
  background: linear-gradient(135deg, var(--color-gray-100) 0%, var(--color-gray-200) 100%);
  border-radius: var(--radius-full);
  display: flex;
  align-items: center;
  justify-content: center;
}

.empty-state-icon svg {
  color: var(--color-gray-400);
}

.empty-state h3 {
  font-size: var(--text-xl);
  color: var(--color-gray-700);
  margin-bottom: var(--space-md);
}

.empty-state p {
  color: var(--color-gray-500);
  margin-bottom: var(--space-xl);
  max-width: 400px;
  margin-left: auto;
  margin-right: auto;
}

/* Responsive */
@media (max-width: 768px) {
  .milestones-section {
    margin-bottom: var(--space-xl);
  }
  
  .milestones-section-title {
    font-size: var(--text-lg);
  }
  
  .milestone-stats-overview {
    flex-direction: column;
  }
  
  .page-header-with-stats .milestone-stats-overview {
    width: 100%;
  }
  
  .milestone-gallery {
    grid-template-columns: 1fr;
  }
  
  .milestone-gallery-card {
    padding: var(--space-lg);
  }
  
  .milestone-gallery-icon {
    width: 52px;
    height: 52px;
  }
  
  .milestone-gallery-icon svg {
    width: 24px;
    height: 24px;
  }
  
  .milestone-gallery-title {
    font-size: var(--text-base);
  }
  
  .milestone-gallery-meta {
    flex-direction: column;
    gap: var(--space-xs);
  }
}
</style>

<%- include('../../partials/portal-footer') %>
