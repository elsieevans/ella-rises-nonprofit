<%- include('../../partials/portal-header', { currentPage: 'participants', pageTitle: participant.first_name + ' ' + participant.last_name }) %>

<div class="page-actions">
  <a href="/portal/participants" class="btn btn-outline">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
    Back to Participants
  </a>
  <% if (user && user.role === 'manager') { %>
    <a href="/portal/participants/<%= participant.id %>/edit" class="btn btn-primary">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Edit
    </a>
  <% } %>
</div>

<div class="detail-grid">
  <!-- Main Info Card -->
  <div class="detail-card">
    <div class="detail-header">
      <div class="detail-avatar">
        <%= participant.first_name.charAt(0) %><%= participant.last_name.charAt(0) %>
      </div>
      <div class="detail-title">
        <h2><%= participant.first_name %> <%= participant.last_name %></h2>
        <span class="status-badge <%= participant.is_active ? 'status-active' : 'status-inactive' %>">
          <%= participant.is_active ? 'Active' : 'Inactive' %>
        </span>
      </div>
    </div>
    
    <div class="detail-section">
      <h3>Contact Information</h3>
      <dl class="detail-list">
        <dt>Email</dt>
        <dd><a href="mailto:<%= participant.email %>"><%= participant.email %></a></dd>
        <dt>Phone</dt>
        <dd><%= participant.phone || '-' %></dd>
        <dt>Date of Birth</dt>
        <dd><%= participant.date_of_birth ? new Date(participant.date_of_birth).toLocaleDateString() : '-' %></dd>
      </dl>
    </div>
    
    <div class="detail-section">
      <h3>School Information</h3>
      <dl class="detail-list">
        <dt>School</dt>
        <dd><%= participant.school || '-' %></dd>
        <dt>Grade Level</dt>
        <dd><%= participant.grade_level || '-' %></dd>
      </dl>
    </div>
    
    <div class="detail-section">
      <h3>Parent/Guardian</h3>
      <dl class="detail-list">
        <dt>Name</dt>
        <dd><%= participant.parent_guardian_name || '-' %></dd>
        <dt>Email</dt>
        <dd><%= participant.parent_guardian_email ? '<a href="mailto:' + participant.parent_guardian_email + '">' + participant.parent_guardian_email + '</a>' : '-' %></dd>
        <dt>Phone</dt>
        <dd><%= participant.parent_guardian_phone || '-' %></dd>
      </dl>
    </div>
    
    <% if (participant.interests) { %>
    <div class="detail-section">
      <h3>Interests</h3>
      <p><%= participant.interests %></p>
    </div>
    <% } %>
    
    <% if (participant.notes) { %>
    <div class="detail-section">
      <h3>Notes</h3>
      <p><%= participant.notes %></p>
    </div>
    <% } %>
    
    <div class="detail-section">
      <h3>Enrollment</h3>
      <dl class="detail-list">
        <dt>Enrollment Date</dt>
        <dd><%= participant.enrollment_date ? new Date(participant.enrollment_date).toLocaleDateString() : '-' %></dd>
        <dt>Created</dt>
        <dd><%= participant.created_at ? new Date(participant.created_at).toLocaleString() : '-' %></dd>
      </dl>
    </div>
  </div>
  
  <!-- Milestones Card -->
  <div class="detail-card">
    <div class="card-header">
      <h3>Milestones Achieved (<%= milestones.length %>)</h3>
    </div>
    
    <% if (milestones && milestones.length > 0) { %>
      <ul class="milestone-list">
        <% milestones.forEach(m => { %>
          <li class="milestone-item">
            <div class="milestone-badge milestone-badge--<%= m.category %>">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
            </div>
            <div class="milestone-info">
              <span class="milestone-name"><%= m.name %></span>
              <span class="milestone-date">Achieved: <%= new Date(m.achieved_date).toLocaleDateString() %></span>
              <% if (m.achievement_notes) { %>
                <span class="milestone-notes"><%= m.achievement_notes %></span>
              <% } %>
            </div>
            <% if (user && user.role === 'manager') { %>
              <form action="/portal/participants/<%= participant.id %>/milestones/<%= m.pm_id %>/delete" method="POST" class="milestone-delete">
                <button type="submit" class="btn-icon btn-icon--small" title="Remove" onclick="return confirm('Remove this milestone?')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
              </form>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="no-data">No milestones achieved yet</p>
    <% } %>
    
    <% if (user && user.role === 'manager' && availableMilestones && availableMilestones.length > 0) { %>
      <div class="card-footer">
        <h4>Assign New Milestone</h4>
        <form action="/portal/participants/<%= participant.id %>/milestones" method="POST" class="inline-form">
          <div class="form-row">
            <select name="milestone_id" required>
              <option value="">Select milestone...</option>
              <% availableMilestones.forEach(m => { %>
                <option value="<%= m.id %>"><%= m.name %> (<%= m.category %>)</option>
              <% }) %>
            </select>
            <input type="date" name="achieved_date" value="<%= new Date().toISOString().split('T')[0] %>" required>
          </div>
          <input type="text" name="notes" placeholder="Notes (optional)">
          <button type="submit" class="btn btn-secondary btn-sm">Assign</button>
        </form>
      </div>
    <% } %>
  </div>
  
  <!-- Events Card -->
  <div class="detail-card">
    <div class="card-header">
      <h3>Event History (<%= events.length %>)</h3>
    </div>
    
    <% if (events && events.length > 0) { %>
      <ul class="event-list">
        <% events.forEach(e => { %>
          <li class="event-item">
            <div class="event-date-mini">
              <span class="month"><%= new Date(e.event_date).toLocaleString('en-US', { month: 'short' }) %></span>
              <span class="day"><%= new Date(e.event_date).getDate() %></span>
            </div>
            <div class="event-info">
              <a href="/portal/events/<%= e.id %>" class="event-title"><%= e.title %></a>
              <span class="event-meta"><%= e.event_type %></span>
            </div>
            <span class="status-badge status-<%= e.status %>"><%= e.status %></span>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="no-data">No event history</p>
    <% } %>
  </div>
</div>

<%- include('../../partials/portal-footer') %>

