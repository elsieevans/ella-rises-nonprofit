<%- include('../../partials/portal-header', { currentPage: 'events', pageTitle: event.EventName }) %>

<div class="page-actions">
  <a href="/portal/events" class="btn btn-outline">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
    Back to Events
  </a>
  <% if (user && user.role === 'Admin') { %>
    <a href="/portal/events/<%= event.EventID %>/edit" class="btn btn-primary">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Edit
    </a>
  <% } %>
</div>

<div class="detail-grid">
  <!-- Main Info Card -->
  <div class="detail-card detail-card--wide">
    <div class="event-header">
      <% if (event.EventDateTimeStart) { %>
      <div class="event-date-large">
        <span class="month"><%= new Date(event.EventDateTimeStart).toLocaleString('en-US', { month: 'short' }) %></span>
        <span class="day"><%= new Date(event.EventDateTimeStart).getDate() %></span>
        <span class="year"><%= new Date(event.EventDateTimeStart).getFullYear() %></span>
      </div>
      <% } %>
      <div class="event-title-section">
        <span class="type-badge type-<%= event.EventType ? event.EventType.toLowerCase() : 'other' %>"><%= event.EventType %></span>
        <h2><%= event.EventName %></h2>
      </div>
    </div>
    
    <% if (event.EventDescription) { %>
    <div class="detail-section">
      <h3>Description</h3>
      <p><%= event.EventDescription %></p>
    </div>
    <% } %>
    
    <div class="detail-section">
      <h3>Event Details</h3>
      <dl class="detail-list detail-list--horizontal">
        <dt>Date</dt>
        <dd><%= event.EventDateTimeStart ? new Date(event.EventDateTimeStart).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'Not set' %></dd>
        <dt>Time</dt>
        <dd>
          <% if (event.EventDateTimeStart) { %>
          <%= new Date(event.EventDateTimeStart).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
          <% if (event.EventDateTimeEnd) { %> - <%= new Date(event.EventDateTimeEnd).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %><% } %>
          <% } else { %>
            Not set
          <% } %>
        </dd>
        <dt>Location</dt>
        <dd><%= event.EventLocation || '-' %></dd>
        <dt>Capacity</dt>
        <dd><%= event.EventCapacity ? event.EventCapacity + ' max' : 'Unlimited' %></dd>
      </dl>
    </div>
    
    <% if (surveyStats && surveyStats.total_responses > 0) { %>
    <div class="detail-section">
      <h3>Survey Results (<%= surveyStats.total_responses %> responses)</h3>
      <div class="survey-scores">
        <div class="score-item">
          <span class="score-label">Satisfaction</span>
          <span class="score-value"><%= parseFloat(surveyStats.avg_satisfaction) % 1 === 0 ? Math.round(parseFloat(surveyStats.avg_satisfaction)) : parseFloat(surveyStats.avg_satisfaction).toFixed(1) %>/5</span>
        </div>
        <div class="score-item">
          <span class="score-label">Usefulness</span>
          <span class="score-value"><%= parseFloat(surveyStats.avg_usefulness) % 1 === 0 ? Math.round(parseFloat(surveyStats.avg_usefulness)) : parseFloat(surveyStats.avg_usefulness).toFixed(1) %>/5</span>
        </div>
        <div class="score-item">
          <span class="score-label">Recommendation</span>
          <span class="score-value"><%= parseFloat(surveyStats.avg_recommendation) % 1 === 0 ? Math.round(parseFloat(surveyStats.avg_recommendation)) : parseFloat(surveyStats.avg_recommendation).toFixed(1) %>/5</span>
        </div>
      </div>
    </div>
    <% } %>
  </div>
  
  <!-- Participants Card -->
  <div class="detail-card">
    <div class="card-header">
      <h3>Registered Participants (<%= participants.length %>)</h3>
    </div>
    
    <% if (participants && participants.length > 0) { %>
      <div class="table-responsive">
        <table class="data-table data-table--compact">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <% if (user && user.role === 'Admin') { %><th>Actions</th><% } %>
            </tr>
          </thead>
          <tbody>
            <% participants.forEach(p => { %>
              <tr>
                <td data-label="Name">
                  <a href="/portal/participants/<%= p.ParticipantID %>"><%= p.ParticipantFirstName %> <%= p.ParticipantLastName %></a>
                </td>
                <td data-label="Status">
                  <span class="status-badge status-<%= p.RegistrationStatus %>"><%= p.RegistrationStatus %></span>
                </td>
                <% if (user && user.role === 'Admin') { %>
                  <td data-label="Update" class="actions-col">
                    <form action="/portal/events/<%= event.EventID %>/participants/<%= p.RegistrationID %>/status" method="POST" class="inline-form">
                      <select name="status" onchange="this.form.submit()">
                        <option value="registered" <%= p.RegistrationStatus === 'registered' ? 'selected' : '' %>>Registered</option>
                        <option value="attended" <%= p.RegistrationStatus === 'attended' ? 'selected' : '' %>>Attended</option>
                        <option value="no-show" <%= p.RegistrationStatus === 'no-show' ? 'selected' : '' %>>No-Show</option>
                        <option value="cancelled" <%= p.RegistrationStatus === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                      </select>
                    </form>
                  </td>
                <% } %>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="no-data">No participants registered</p>
    <% } %>
    
    <% if (user && user.role === 'Admin') { %>
      <% if (availableParticipants && availableParticipants.length > 0) { %>
        <div class="card-footer">
          <h4>Register Participant</h4>
          <form action="/portal/events/<%= event.EventID %>/participants" method="POST" class="inline-form">
            <select name="participant_id" required>
              <option value="">Select participant...</option>
              <% availableParticipants.forEach(p => { %>
                <option value="<%= p.ParticipantID %>"><%= p.ParticipantFirstName %> <%= p.ParticipantLastName %></option>
              <% }) %>
            </select>
            <button type="submit" class="btn btn-secondary btn-sm">Register</button>
          </form>
        </div>
      <% } %>
    <% } else { %>
      <% const isUserRegistered = participants.some(p => p.ParticipantID === user.id); %>
      <% if (!isUserRegistered) { %>
        <div class="card-footer">
          <form action="/portal/events/<%= event.EventID %>/participants" method="POST" class="inline-form">
            <input type="hidden" name="participant_id" value="<%= user.id %>">
            <button type="submit" class="btn btn-primary btn-sm">Register Me for This Event</button>
          </form>
        </div>
      <% } else { %>
        <div class="card-footer">
          <p class="text-success">âœ“ You are registered for this event</p>
        </div>
      <% } %>
    <% } %>
  </div>
  
  <!-- Surveys Card -->
  <div class="detail-card">
    <div class="card-header">
      <h3>Survey Responses (<%= surveys.length %>)</h3>
    </div>
    
    <% if (surveys && surveys.length > 0) { %>
      <ul class="survey-list">
        <% surveys.forEach(s => { %>
          <li class="survey-item">
            <div class="survey-scores-mini">
              <span title="Satisfaction">ğŸ˜Š <%= s.SurveySatisfactionScore %>/5</span>
              <span title="Usefulness">ğŸ“š <%= s.SurveyUsefulnessScore %>/5</span>
              <span title="Recommendation">ğŸ‘ <%= s.SurveyRecommendationScore %>/5</span>
            </div>
            <% if (s.ParticipantFirstName) { %>
              <span class="survey-respondent"><%= s.ParticipantFirstName %> <%= s.ParticipantLastName %></span>
            <% } %>
            <% if (s.SurveyComments) { %>
              <p class="survey-feedback">"<%= s.SurveyComments.substring(0, 100) %><%= s.SurveyComments.length > 100 ? '...' : '' %>"</p>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="no-data">No survey responses yet</p>
    <% } %>
  </div>
</div>

<%- include('../../partials/portal-footer') %>
