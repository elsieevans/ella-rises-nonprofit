<%- include('../../partials/portal-header', { currentPage: 'events', pageTitle: event.title }) %>

<div class="page-actions">
  <a href="/portal/events" class="btn btn-outline">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
    Back to Events
  </a>
  <% if (user && user.role === 'manager') { %>
    <a href="/portal/events/<%= event.id %>/edit" class="btn btn-primary">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Edit
    </a>
  <% } %>
</div>

<div class="detail-grid">
  <!-- Main Info Card -->
  <div class="detail-card detail-card--wide">
    <div class="event-header">
      <div class="event-date-large">
        <span class="month"><%= new Date(event.event_date).toLocaleString('en-US', { month: 'short' }) %></span>
        <span class="day"><%= new Date(event.event_date).getDate() %></span>
        <span class="year"><%= new Date(event.event_date).getFullYear() %></span>
      </div>
      <div class="event-title-section">
        <span class="type-badge type-<%= event.event_type %>"><%= event.event_type %></span>
        <h2><%= event.title %></h2>
        <span class="status-badge <%= event.is_active ? 'status-active' : 'status-inactive' %>">
          <%= event.is_active ? 'Active' : 'Inactive' %>
        </span>
      </div>
    </div>
    
    <% if (event.description) { %>
    <div class="detail-section">
      <h3>Description</h3>
      <p><%= event.description %></p>
    </div>
    <% } %>
    
    <div class="detail-section">
      <h3>Event Details</h3>
      <dl class="detail-list detail-list--horizontal">
        <dt>Date</dt>
        <dd><%= new Date(event.event_date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></dd>
        <dt>Time</dt>
        <dd>
          <% if (event.start_time) { %>
            <%= event.start_time.substring(0, 5) %><% if (event.end_time) { %> - <%= event.end_time.substring(0, 5) %><% } %>
          <% } else { %>
            -
          <% } %>
        </dd>
        <dt>Location</dt>
        <dd><%= event.venue_name || '-' %><% if (event.location) { %><br><small><%= event.location %></small><% } %></dd>
        <dt>Instructor</dt>
        <dd><%= event.instructor || '-' %></dd>
        <dt>Partner</dt>
        <dd><%= event.partner_organization || '-' %></dd>
        <dt>Capacity</dt>
        <dd><%= event.current_participants || 0 %><% if (event.max_participants) { %> / <%= event.max_participants %><% } %></dd>
      </dl>
    </div>
    
    <% if (surveyStats && surveyStats.total_responses > 0) { %>
    <div class="detail-section">
      <h3>Survey Results (<%= surveyStats.total_responses %> responses)</h3>
      <div class="survey-scores">
        <div class="score-item">
          <span class="score-label">Satisfaction</span>
          <span class="score-value"><%= parseFloat(surveyStats.avg_satisfaction).toFixed(1) %>/5</span>
        </div>
        <div class="score-item">
          <span class="score-label">Usefulness</span>
          <span class="score-value"><%= parseFloat(surveyStats.avg_usefulness).toFixed(1) %>/5</span>
        </div>
        <div class="score-item">
          <span class="score-label">Recommendation</span>
          <span class="score-value"><%= parseFloat(surveyStats.avg_recommendation).toFixed(1) %>/10</span>
        </div>
      </div>
    </div>
    <% } %>
  </div>
  
  <!-- Participants Card -->
  <div class="detail-card">
    <div class="card-header">
      <h3>Registered Participants (<%= participants.length %>)</h3>
    </div>
    
    <% if (participants && participants.length > 0) { %>
      <div class="table-responsive">
        <table class="data-table data-table--compact">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <% if (user && user.role === 'manager') { %><th>Actions</th><% } %>
            </tr>
          </thead>
          <tbody>
            <% participants.forEach(p => { %>
              <tr>
                <td data-label="Name">
                  <a href="/portal/participants/<%= p.id %>"><%= p.first_name %> <%= p.last_name %></a>
                </td>
                <td data-label="Status">
                  <span class="status-badge status-<%= p.status %>"><%= p.status %></span>
                </td>
                <% if (user && user.role === 'manager') { %>
                  <td data-label="Update" class="actions-col">
                    <form action="/portal/events/<%= event.id %>/participants/<%= p.ep_id %>/status" method="POST" class="inline-form">
                      <select name="status" onchange="this.form.submit()">
                        <option value="registered" <%= p.status === 'registered' ? 'selected' : '' %>>Registered</option>
                        <option value="attended" <%= p.status === 'attended' ? 'selected' : '' %>>Attended</option>
                        <option value="no-show" <%= p.status === 'no-show' ? 'selected' : '' %>>No-Show</option>
                        <option value="cancelled" <%= p.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                      </select>
                    </form>
                  </td>
                <% } %>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="no-data">No participants registered</p>
    <% } %>
    
    <% if (user && user.role === 'manager' && availableParticipants && availableParticipants.length > 0) { %>
      <div class="card-footer">
        <h4>Register Participant</h4>
        <form action="/portal/events/<%= event.id %>/participants" method="POST" class="inline-form">
          <select name="participant_id" required>
            <option value="">Select participant...</option>
            <% availableParticipants.forEach(p => { %>
              <option value="<%= p.id %>"><%= p.first_name %> <%= p.last_name %></option>
            <% }) %>
          </select>
          <button type="submit" class="btn btn-secondary btn-sm">Register</button>
        </form>
      </div>
    <% } %>
  </div>
  
  <!-- Surveys Card -->
  <div class="detail-card">
    <div class="card-header">
      <h3>Survey Responses (<%= surveys.length %>)</h3>
    </div>
    
    <% if (surveys && surveys.length > 0) { %>
      <ul class="survey-list">
        <% surveys.forEach(s => { %>
          <li class="survey-item">
            <div class="survey-scores-mini">
              <span title="Satisfaction">ğŸ˜Š <%= s.satisfaction_score %>/5</span>
              <span title="Usefulness">ğŸ“š <%= s.usefulness_score %>/5</span>
              <span title="Recommendation">ğŸ‘ <%= s.recommendation_score %>/10</span>
            </div>
            <% if (s.first_name) { %>
              <span class="survey-respondent"><%= s.first_name %> <%= s.last_name %></span>
            <% } %>
            <% if (s.what_liked) { %>
              <p class="survey-feedback">"<%= s.what_liked.substring(0, 100) %><%= s.what_liked.length > 100 ? '...' : '' %>"</p>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="no-data">No survey responses yet</p>
    <% } %>
  </div>
</div>

<%- include('../../partials/portal-footer') %>

